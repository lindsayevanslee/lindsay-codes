{
  "hash": "bfdbd3b8174622f4a1b802b796cae42d",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"Drawing a custom map for Power BI\"\ndescription: \"It took like 4 different programs but we did it.\"\ndate: \"2023-03-26\"\nimage: power-bi-map.png\nimage-alt: \"Screenshot of Power BI report page with custom map in an ArcGIS visual\"\ncategories: [maps, power bi, r]\nexecute: \n  eval: false\n---\n\n***Update 2025-08-24**: I've since found a much easier way to do this using OpenStreetMap, which you can read about [here](../power-bi-custom-map-using-openstreetmap/index.qmd).*\n\nIn Power BI it's fairly easy to generate a map with location data that fits typical geographical boundaries like countries or states. If you want to draw a very custom map, it becomes more difficult. This is a way I figured out that seems much more complicated than it needs to be. I'm sure (I hope) there is an easier way that I'll discover later.\n\nCurrently Power BI has multiple built-in mapping visualizations. You can draw custom shapes with the \"Shape Map\", but it will be on a blank white background. I wanted my map to lay on top of a typical street map. The ArcGIS visualization makes this possible.\n\nIf you have an ArcGIS license, you can draw your custom maps within ArcGIS itself and access them via Power BI. This didn't work for me for a couple reasons: 1. I didn't have a license, and 2. I don't know if you can connect your data in Power BI to reference layers you create within ArcGIS. So that makes I need to find a way to have custom location data within Power BI formatted in such a way that it is parseable by the ArcGIS visualization. After lots of digging (ArcGIS's documentation is lacking), I found that custom shapes can be read from Power BI data in an [\"EsriJSON format\"](https://doc.arcgis.com/en/power-bi/get-started/prepare-your-data.htm).\n\nFirst, I drew my map in Google Earth. Start a new project (it works best in Chrome), and click \"New feature\" -\\> \"Draw line or shape\".\n\n![](google-earth-draw.png){fig-alt=\"Screenshot of Google Earth showing \\\"Draw line or shape\\\" option\"}\n\nTrace out your shape, and give it a name. When you've finished drawing your map, go to the \"...\" menu and click \"Export as KML file\". I don't really know what a KML is, but from what I can tell it's a map format that Google likes to use.\n\n![](google-earth-export-kml.png){fig-alt=\"Screenshot of Google Earth showing \\\"Export as KML file\\\" option\"}\n\nNext, the KML file needs to be converted to a form of JSON called GeoJSON. Again, don't ask me what a GeoJSON is, but from context clues I'm gonna say it's a JSON for geographic data.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n#open necessary libraries\nlibrary(sf)\nlibrary(tidyverse)\n\n#read in kml file\nmap_geo <- sf::st_read(\"Example Project.kml\")\n\n#spit it back out again as a GeoJSON\nmap_geo %>% \n  st_zm() %>% #remove the Z dimension from the object\n  st_write(\"Example Project.geojson\")\n```\n:::\n\n\nGeoJSON isn't good enough for finicky ArcGIS/Power BI however, so we need to do a bit more wrangling to create a table that has shape data in an EsriJSON format. [This website](https://docs.safe.com/fme/html/FME_Desktop_Documentation/FME_ReadersWriters/esrijson/esrijson.htm) and [this question on the ArcGIS forum](https://community.esri.com/t5/arcgis-for-power-bi-questions/some-polygons-not-displaying-in-powerbi-visual/td-p/1168070) helped me figure out what this mysterious EsriJSON needed to look like.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n#open necessary libraries\nlibrary(jsonlite)\nlibrary(tidyverse)\n\n#read in geojson file\nlist_json <- read_json(\"Example Project.geojson\")\n\n#wrangle into EsriJSON format\ndf_parsed <- list_json$features %>%\n  map_dfr(.f = function(lst_elm) {\n    lst_elm %>%\n      enframe() %>%\n      pivot_wider()\n  }) %>%\n  unnest_wider(properties) %>%\n  select(-type) %>%\n  unnest_wider(geometry) %>%\n  mutate(coordinates = unlist(coordinates, recursive = FALSE)) %>%\n  mutate(coordinates = map(coordinates, toJSON, digits = 20)) %>%\n  mutate(coordinates = as.character(coordinates)) %>%\n  mutate(coordinates = str_replace(coordinates, \"\\\\]$\", '\\\\]\\\\}')) %>%\n  mutate(coordinates = str_replace(coordinates, \"\\\\[\", '\\\\{\"rings\": \\\\[')) %>%\n  mutate(coordinates = str_replace_all(coordinates, \"\\\\],\\\\[\", \",\"))\n\n\n#print csv with EsriJSON column\nwrite_csv(df_parsed, file = \"Example Project.csv\")\n```\n:::\n\n\nFinally, load this csv file into your Power BI report, put an ArcGIS visualization on your report canvas, and use the `coordinates` column in the \"Location\" field to create your custom map.\n\n![](power-bi-map.png){fig-alt=\"Screenshot of Power BI report page with custom map in an ArcGIS visual\"}\n\nIf you create relationships between this table and other data in your model, then you can overlay more data on this map via coloring, sizing, and tooltips.\n\nThat's it! Easy! I'm gonna go take a nap.\n",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}